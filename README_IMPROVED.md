# 🚗 자율주행 RC카 - 개선된 회피 시스템

## 📋 개선 사항

### 1. 복합 센서 기반 회피

- ✅ 초음파 센서 (정면)
- ✅ 적외선 센서 (좌/우)
- ✅ 비전 센서 (카메라)

### 2. 지능형 FSM (상태 기계)

- **EXPLORE**: 정상 주행 - 비전 기반 경로 추종
- **AVOID**: 장애물 회피 - 센서 조합 분석
- **EMERGENCY_BACK**: 긴급 후진 - 위험 상황
- **TURN_AROUND**: 180도 회전 - 막다른 골목

### 3. 스마트 회피 로직

#### 센서 조합별 대응:

```
정면 막힘:
  - 좌우 뚫림 → 비전으로 넓은 쪽 선택
  - 좌측만 뚫림 → 좌측 회피
  - 우측만 뚫림 → 우측 회피

좌측 막힘:
  - 우측으로 평행 이동

우측 막힘:
  - 좌측으로 평행 이동

정면+좌우 막힘:
  - 긴급 후진 → 180도 회전
```

#### 연속 회피 감지:

- 5회 연속 회피 → 막다른 골목 판단 → 방향 전환

### 4. 비전 기반 경로 보정

- 오프셋 < 50px: 직진
- 오프셋 50~100px: 부드러운 회전 + 전진
- 오프셋 > 100px: 제자리 회전 + 전진

## 🎮 사용 방법

### 실행

```powershell
cd C:\25L\icane
python main.py
```

### 종료

- **Q 키** 또는 **ESC 키** 또는 **ctrl+c 키**

### 디버그 창

- **ROI/FreeSpace**: 경로 인식 영역
- **Mask**: 바닥 감지 마스크

## ⚙️ 파라미터 튜닝

### config.py에서 조정:

```python
# 속도 조정
SPEED_FWD = 8       # 전진 속도 (6~10)
SPEED_TURN = 6      # 회전 속도 (4~8)
SPEED_AVOID = 7     # 회피 속도 (5~9)

# 경로 추종 감도
CENTER_DEADBAND = 50  # 작을수록 민감 (30~70)

# 센서 감도
ULTRA_THRESH_CM = 35  # 초음파 감지 거리
```

### fsm.py에서 회피 동작 조정:

```python
# 후진 거리
ctrl.back(6); sleep(0.4)  # 숫자를 높이면 더 멀리 후진

# 회전 각도
ctrl.rleft(7); sleep(0.6)  # sleep 시간을 늘리면 더 많이 회전

# 연속 회피 임계값
if avoid_counter >= 5:  # 5를 3~10으로 조정 가능
```

## 🔧 문제 해결

### 회피가 너무 민감함

```python
# config.py
CENTER_DEADBAND = 70  # 증가
SPEED_FWD = 7  # 감소
```

### 회피가 느림

```python
# config.py
SPEED_AVOID = 9  # 증가
```

### 자꾸 제자리 회전

```python
# fsm.py, line ~130
if abs(off) > 120:  # 100에서 120으로 증가
```

### 센서가 작동하지 않음

```python
# sensors.py에서 PIN 번호 확인
PIN_ULTRA_FRONT = 2
PIN_IR_LEFT = 13
PIN_IR_RIGHT = 12
```

## 📊 동작 흐름

```
시작
  ↓
센서 읽기 (초음파, IR, 카메라)
  ↓
장애물 있음?
  ├─ YES → 센서 조합 분석
  │         ├─ 정면+좌우 → 180도 회전
  │         ├─ 정면 → 좌/우 선택 회피
  │         └─ 좌/우 → 반대 방향 회피
  │
  └─ NO → 비전 기반 주행
            ├─ 오프셋 계산
            └─ 경로 보정
```

## 🎯 최적화 팁

1. **밝은 환경에서 테스트**: 비전 인식 정확도 향상
2. **바닥 색상 확인**: 밝고 균일한 바닥이 좋음
3. **센서 청소**: 먼지가 끼면 오작동
4. **배터리 확인**: 저전압 시 모터 성능 저하
5. **테스트 공간**: 처음엔 넓은 공간에서

## 📝 로그 메시지

```
[OK] RoboCam 로드 성공
[OK] RoboCam 스트림 시작
[EXPLORE] 비전 없음 → 저속 직진
[AVOID] 정면 막힘 → 왼쪽으로
[EMERGENCY] 막다른 골목! 180도 회전
[WARNING] 연속 회피 5회! 방향 전환
```

## 🚀 다음 단계

### 추가 개선 가능:

1. 속도 적응형 제어 (장애물 거리에 따라 속도 조절)
2. 경로 기억 (이미 간 곳 피하기)
3. 목표 지점 설정 (특정 위치로 이동)
4. 다중 장애물 우선순위 처리

---

**수정 날짜**: 2025-10-24
**버전**: 2.0 (스마트 회피 시스템)
